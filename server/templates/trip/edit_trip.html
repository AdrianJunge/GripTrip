{% extends "base.html" %}

{% block head %}
    <title>Edit Trip - {{ app_name }}</title>
{% endblock %}

{% block content %}
<h1 class="m-3">Edit Trip</h1>
<form method="POST" action="{{ url_for('trip.edit_trip', trip_id=trip.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
    <div class="card m-3">
        <div class="card-body">
            <h5 class="card-title">Mandatory</h5>

            <div class="mb-3">
                <label for="tripName" class="form-label">Trip Name</label>
                <input type="text" class="form-control" id="tripName" name="trip_name" value="{{ trip.title }}" required>
            </div>

            <div class="mb-3">
                <label for="maxParticipants" class="form-label">Maximum Participants</label>
                <input type="number" class="form-control" id="maxParticipants" name="max_participants" min="1" value="{{ trip.max_participants }}">
            </div>

            <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    {% for status in ProposalStatus %}
                        <option
                            value="{{ status.name }}"
                            {% if trip.status.name == status.name %}
                                selected
                            {% endif %}
                            {% if status.name == 'FINALIZED' and not all_final %}
                                disabled
                            {% endif %}
                        >
                            {{ status.name.replace('_', ' ').title() }}
                        </option>
                    {% endfor %}
                </select>
                {% if not all_final %}
                    <div class="form-text text-warning">All detail fields must be finalized before marking the trip as FINALIZED.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card m-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Optional / Tentative details</strong>
            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#optionalCollapse" aria-expanded="false" aria-controls="optionalCollapse">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="card card-body collapse" id="optionalCollapse">

            <div class="mb-3">
                <label class="form-label">Destination Sites</label>
                <div class="d-flex gap-2">
                    <input name="destinations" class="form-control tagify {% if trip.is_final('destinations') %}opacity-50{% endif %}" placeholder="Add destinations" value="{{ trip.destinations|join(',') if trip.destinations else '' }}" {% if trip.is_final('destinations') %}readonly{% endif %}>
                    <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('destinations') else 'success' }} toggle-final-btn" data-field="destinations" data-action="{{ 'unfinalize' if trip.is_final('destinations') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('destinations') else 'Finalize' }}</button>
                </div>
                <div class="form-text">Press enter or comma to add multiple destinations.</div>
            </div>

            <div class="mb-3 mv-dates-widget" data-finalized="{{ 'true' if trip.is_final('dates') else 'false' }}">
                <label class="form-label">Date ranges</label>
                <div class="d-flex gap-2 mb-2">
                    <input type="date" class="form-control mv-start {% if trip.is_final('dates') %}opacity-50{% endif %}" placeholder="Start date" value="{%- if trip.dates and trip.dates|length > 0 %}{{ trip.dates[0][0] }}{%- endif %}" {% if trip.is_final('dates') %}readonly{% endif %}>
                    <input type="date" class="form-control mv-end {% if trip.is_final('dates') %}opacity-50{% endif %}" placeholder="End date" value="{%- if trip.dates and trip.dates|length > 0 %}{{ trip.dates[0][1] }}{%- endif %}" {% if trip.is_final('dates') %}readonly{% endif %}>
                    <button type="button" class="btn btn-outline-secondary mv-add" {% if trip.is_final('dates') %}disabled{% endif %}>Add range</button>
                    <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('dates') else 'success' }} toggle-final-btn" data-field="dates" data-action="{{ 'unfinalize' if trip.is_final('dates') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('dates') else 'Finalize' }}</button>
                </div>
                <div class="mv-list">
                    {%- for s,e in trip.dates %}
                        <input type="hidden" name="start_date" value="{{ s }}" class="mv-item-input">
                        <input type="hidden" name="end_date" value="{{ e }}" class="mv-item-input">
                    {%- endfor %}
                </div>
            </div>

            <div class="mb-3 d-flex align-items-end gap-2">
                <div class="flex-grow-1">
                    <label for="budget" class="form-label">Budget</label>
                    <input type="number" class="form-control {% if trip.is_final('budget') %}opacity-50{% endif %}" id="budget" name="budget" value="{{ trip.budget or '' }}" {% if trip.is_final('budget') %}readonly{% endif %} min="0" step="0.01">
                </div>
                <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('budget') else 'success' }} toggle-final-btn" data-field="budget" data-action="{{ 'unfinalize' if trip.is_final('budget') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('budget') else 'Finalize' }}</button>
            </div>

            <div class="mb-3 d-flex align-items-end gap-2">
                <div class="flex-grow-1">
                    <label for="accommodation" class="form-label">Accommodation</label>
                    <input type="text" class="form-control {% if trip.is_final('accommodation') %}opacity-50{% endif %}" id="accommodation" name="accommodation" value="{{ trip.accommodation or '' }}" {% if trip.is_final('accommodation') %}readonly{% endif %}>
                </div>
                <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('accommodation') else 'success' }} toggle-final-btn" data-field="accommodation" data-action="{{ 'unfinalize' if trip.is_final('accommodation') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('accommodation') else 'Finalize' }}</button>
            </div>

            <div class="mb-3 d-flex align-items-end gap-2">
                <div class="flex-grow-1">
                    <label for="transportation" class="form-label">Transportation</label>
                    <input type="text" class="form-control {% if trip.is_final('transportation') %}opacity-50{% endif %}" id="transportation" name="transportation" value="{{ trip.transportation or '' }}" {% if trip.is_final('transportation') %}readonly{% endif %}>
                </div>
                <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('transportation') else 'success' }} toggle-final-btn" data-field="transportation" data-action="{{ 'unfinalize' if trip.is_final('transportation') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('transportation') else 'Finalize' }}</button>
            </div>

            <div class="mb-3">
                <label class="form-label">Gear needed</label>
                <div class="d-flex gap-2">
                    <input name="gear_needed" class="form-control tagify {% if trip.is_final('gear_needed') %}opacity-50{% endif %}" placeholder="Add gear needed" value="{{ trip.gear_needed|join(',') if trip.gear_needed else '' }}" {% if trip.is_final('gear_needed') %}readonly{% endif %}>
                    <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('gear_needed') else 'success' }} toggle-final-btn" data-field="gear_needed" data-action="{{ 'unfinalize' if trip.is_final('gear_needed') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('gear_needed') else 'Finalize' }}</button>
                </div>
                <div class="form-text">Press enter or comma to add multiple gear needed</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Climbing Difficulty</label>
                <div class="d-flex gap-2">
                    <input name="difficulty" class="form-control tagify {% if trip.is_final('difficulty') %}opacity-50{% endif %}" placeholder="Add difficulty grades (e.g., 5.10a, V4)" value="{{ trip.difficulty|join(',') if trip.difficulty else '' }}" {% if trip.is_final('difficulty') %}readonly{% endif %}>
                    <button type="button" class="btn btn-outline-{{ 'danger' if trip.is_final('difficulty') else 'success' }} toggle-final-btn" data-field="difficulty" data-action="{{ 'unfinalize' if trip.is_final('difficulty') else 'finalize' }}">{{ 'Unfinalize' if trip.is_final('difficulty') else 'Finalize' }}</button>
                </div>
                <div class="form-text">Press enter or comma to add multiple difficulty grades</div>
            </div>
        </div>
    </div>

    <div class="m-3">
        <button type="submit" class="btn btn-primary"
        {% if trip.status == trip.status.__class__.CANCELLED or (trip.status == trip.status.__class__.FINALIZED and not trip.has_permission(current_user, ProposalParticipantRole.ADMIN)) %}
            disabled
        {% endif %}
        >Save Changes</button>
        <a href="{{ url_for('trip.view_trip', trip_id=trip.id) }}" class="btn btn-secondary ms-2">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js"></script>

    <script src="{{ url_for('static', filename='js/trip/finalize.js') }}"></script>
    <script src="{{ url_for('static', filename='js/trip/multivalue.js') }}"></script>
{% endblock %}
